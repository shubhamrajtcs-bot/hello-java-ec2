name: Java CI/CD to EC2 via S3 and SSM (Tomcat)

on:
  push:
    branches:
      - main

permissions:
  id-token: write     # REQUIRED for OIDC
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout source code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Java 17 on GitHub Runner
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Build WAR using Maven
      - name: Build WAR with Maven
        run: mvn clean package

      # 4. Configure AWS credentials using OIDC
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: arn:aws:iam::712490755516:role/OICDrole

      # 5. Upload WAR to Amazon S3
      - name: Upload WAR to S3
        run: |
          aws s3 cp target/hello-java-ec2-1.0.war \
          s3://${{ secrets.S3_BUCKET_NAME }}/hello-java-ec2-1.0.war

      # 6. Deploy WAR to Tomcat using AWS Systems Manager
      - name: Deploy WAR to Tomcat using SSM
        run: |
          aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy WAR to Tomcat using SSM" \
            --parameters commands='[
              "rm -rf /opt/tomcat/webapps/hello-java-ec2*",
              "aws s3 cp s3://${{ secrets.S3_BUCKET_NAME }}/hello-java-ec2-1.0.war /opt/tomcat/webapps/",
              "/opt/tomcat/bin/shutdown.sh || true",
              "/opt/tomcat/bin/startup.sh"
            ]'
